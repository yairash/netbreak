!function(e){"function"==typeof define&&define.amd?define(["fs","jsdom"],e):e()}((function(){"use strict";let e,t;setTimeout((()=>async function(a){if(!e){const t=await browser.storage.local.get();e=t.tabsData||{}}(async function(){if(!t){t=!0;const a=await browser.tabs.query({currentWindow:!0,highlighted:!0});Object.keys(e).filter((e=>{if("autoSaveAll"!=e&&"autoSaveUnpinned"!=e&&"profileName"!=e)return!a.find((t=>t.id==e))})).forEach((t=>delete e[t])),await browser.storage.local.set({tabsData:e})}})(),void 0===a||e[a]||(e[a]={});return e}().then((t=>e=t))),0);const a="__Default_Settings__",o={removeHiddenElements:!0,removeUnusedStyles:!0,removeUnusedFonts:!0,removeFrames:!1,compressHTML:!0,compressCSS:!1,loadDeferredImages:!0,loadDeferredImagesMaxIdleTime:1500,loadDeferredImagesBlockCookies:!1,loadDeferredImagesBlockStorage:!1,loadDeferredImagesKeepZoomLevel:!1,loadDeferredImagesDispatchScrollEvent:!1,filenameTemplate:"{page-title} ({date-locale} {time-locale}).html",infobarTemplate:"",includeInfobar:!(!/Safari/.test(navigator.userAgent)||/Chrome/.test(navigator.userAgent)||/Vivaldi/.test(navigator.userAgent)||/OPR/.test(navigator.userAgent)),confirmInfobarContent:!1,autoClose:!1,confirmFilename:!1,filenameConflictAction:"uniquify",filenameMaxLength:192,filenameMaxLengthUnit:"bytes",filenameReplacedCharacters:["~","+","\\\\","?","%","*",":","|",'"',"<",">","\0-",""],filenameReplacementCharacter:"_",contextMenuEnabled:!0,tabMenuEnabled:!0,browserActionMenuEnabled:!0,shadowEnabled:!0,logsEnabled:!0,progressBarEnabled:!0,maxResourceSizeEnabled:!1,maxResourceSize:10,displayInfobar:!0,displayStats:!1,backgroundSave:!(/Mobile.*Firefox/.test(navigator.userAgent)||/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/Vivaldi/.test(navigator.userAgent)&&!/OPR/.test(navigator.userAgent)),defaultEditorMode:"normal",applySystemTheme:!0,autoSaveDelay:1,autoSaveLoad:!1,autoSaveUnload:!1,autoSaveLoadOrUnload:!0,autoSaveDiscard:!1,autoSaveRemove:!1,autoSaveRepeat:!1,autoSaveRepeatDelay:10,removeAlternativeFonts:!0,removeAlternativeMedias:!0,removeAlternativeImages:!0,groupDuplicateImages:!0,maxSizeDuplicateImages:524288,saveRawPage:!1,saveToClipboard:!1,addProof:!1,saveToGDrive:!1,saveWithWebDAV:!1,webDAVURL:"",webDAVUser:"",webDAVPassword:"",saveToGitHub:!1,githubToken:"",githubUser:"",githubRepository:"SingleFile-Archives",githubBranch:"main",saveWithCompanion:!1,forceWebAuthFlow:!0,resolveFragmentIdentifierURLs:!1,userScriptEnabled:!1,openEditor:!1,openSavedPage:!1,autoOpenEditor:!1,saveCreatedBookmarks:!1,allowedBookmarkFolders:[],ignoredBookmarkFolders:[],replaceBookmarkURL:!0,saveFavicon:!0,includeBOM:!1,warnUnsavedPage:!0,autoSaveExternalSave:!1,insertMetaNoIndex:!1,insertMetaCSP:!0,passReferrerOnError:!1,insertSingleFileComment:!0,removeSavedDate:!1,blockMixedContent:!1,saveOriginalURLs:!1,acceptHeaders:{font:"application/font-woff2;q=1.0,application/font-woff;q=0.9,*/*;q=0.8",image:"image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8",stylesheet:"text/css,*/*;q=0.1",script:"*/*",document:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",video:"video/webm,video/ogg,video/*;q=0.9,application/ogg;q=0.7,audio/*;q=0.6,*/*;q=0.5",audio:"audio/webm,audio/ogg,audio/wav,audio/*;q=0.9,application/ogg;q=0.7,video/*;q=0.6,*/*;q=0.5"},moveStylesInHead:!1,networkTimeout:0,woleetKey:"",blockImages:!1,blockStylesheets:!1,blockFonts:!1,blockScripts:!0,blockVideos:!0,blockAudios:!0,autoSaveNumberOfLinksManually:10},n=[{url:"file:",profile:"__Default_Settings__",autoSaveProfile:"__Disabled_Settings__"}];let r,s=async function(){const{sync:e}=await browser.storage.local.get();r=e?browser.storage.sync:browser.storage.local;const t=await r.get();if(t.profiles)t.rules||(t.rules=n),Object.keys(t.profiles).forEach((e=>i(t.profiles[e]))),await r.remove(["profiles","rules"]),await r.set({profiles:t.profiles,rules:t.rules});else{const e=t;delete e.tabsData,i(e);const s={profiles:{},rules:n};s.profiles[a]=e,r.remove(Object.keys(o)),await r.set(s)}t.maxParallelWorkers||await r.set({maxParallelWorkers:navigator.hardwareConcurrency||4})}();function i(e){l(e,"blockScripts","removeScripts"),l(e,"blockVideos","removeVideoSrc"),l(e,"blockAudios","removeAudioSrc"),Object.keys(o).forEach((t=>function(e,t){void 0===e[t]&&(e[t]=o[t])}(e,t)))}function l(e,t,a){void 0===e[t]&&void 0!==e[a]&&(e[t]=e[a],delete e[a])}async function c(){return(await async function(){return await s,r.get(["profiles","rules","maxParallelWorkers"])}()).profiles[a].autoSaveNumberOfLinksManually}const d=globalThis.singlefileBootstrap,u=33554432,m="https://net-break.azurewebsites.net/api/httptrigger1";let f,v,p,g,h,b,S,w,E;async function y(e){return h&&"content.autosave"==e.method?(async function(e){v=e.options,"complete"!=document.readyState&&await new Promise((e=>globalThis.addEventListener("load",e)));await A(),v.autoSaveRepeat&&setTimeout((()=>{h&&!S&&(w=!1,v.autoSaveDelay=0,y(e))}),1e3*v.autoSaveRepeatDelay)}(e),{}):"content.maybeInit"==e.method?(D(),{}):"content.init"==e.method?(v=e.options,h=e.autoSaveEnabled,T(),{}):"content.openEditor"==e.method?(I(document)?U(document):T(),{}):"devtools.resourceCommitted"==e.method?(d.pageInfo.updatedResources[e.url]={content:e.content,type:e.type,encoding:e.encoding},{}):void 0}function D(){E==location.href||d.pageInfo.processing||(w=!1,E=location.href,browser.runtime.sendMessage({method:"tabs.init",savedPageDetected:I(document)}).catch((()=>{})),browser.runtime.sendMessage({method:"ui.processInit"}).catch((()=>{})))}async function A(){const e=d.helper;if((!S||b)&&!w)if(S=!0,v.autoSaveDelay&&!b)await new Promise((e=>b=setTimeout(e,1e3*v.autoSaveDelay))),await A();else{const t=window._singleFile_waitForUserScript;let a,o=[];b=null,!v.removeFrames&&globalThis.frames&&globalThis.frames.length&&(o=await d.processors.frameTree.getAsync(v)),a=o&&o.sessionId,v.userScriptEnabled&&t&&await t(e.ON_BEFORE_CAPTURE_EVENT_NAME);const n=function(e){let t=new Map;function a(e,o){if("A"===e.tagName&&e.href&&(e.href.startsWith("http://")||e.href.startsWith("https://"))){const a=e.href;t.has(o)||t.set(o,new Array),t.get(o).push(a)}const n=e.children;for(let t=0;t<n.length;t++)a(n[t],e.tagName)}return a(e.body,""),t}(document);let r=function(e,t){const a=e.location.hostname,o=new Map;return t.forEach(((e,t)=>{const n=Array.from(e).filter((e=>new URL(e).hostname===a));n.length>0&&o.set(t,new Array(n))})),o}(document,n),s=new Map;s=await async function(e){const t=await c();let a,o,n=0,r=[];const s=new Map;for(let[a,o]of e)if(("p"===a||"P"===a)&&(r=r.concat(o[0].slice(0,t-n)),n+=r.length,n>=t))break;const i=await browser.runtime.sendMessage({method:"autosave.fetchdom",server:m,urls:r}),l=JSON.parse(i);for(let e=0;e<l.length;e++){let t=l[e],n=(new DOMParser).parseFromString(t,"text/html");a=await R(n),o=!1===a.downloadComplete?null:a.fileName,s.set(r[e],o)}return s}(r),await async function(e,t){let a=null;const o=e.getElementsByTagName("a");for(let[e,n]of t){if(null===n)continue;const t=`file://${n}`;null===a?a=new URL(e):a.href=e;for(const e of o)if(e.getAttribute("href")===a.href||e.getAttribute("href")===a.pathname){e.setAttribute("href",t),e.style.color="green";break}}}(document,s);const i=e.preProcessDoc(document,globalThis,v);await C(i,o),a&&d.processors.frameTree.cleanup(a),e.postProcessDoc(document,i.markedElements,i.invalidElements),v.userScriptEnabled&&t&&await t(e.ON_AFTER_CAPTURE_EVENT_NAME),w=!0,S=!1}}async function R(e,t){const a=d.helper;let o;try{let t,n=[];b=null,n=await d.processors.frameTree.getAsync(v),t=n&&n.sessionId,v.userScriptEnabled&&waitForUserScript&&await waitForUserScript(a.ON_BEFORE_CAPTURE_EVENT_NAME);const r=a.preProcessDoc(e,null,v);o=C(r,n,e),t&&d.processors.frameTree.cleanup(t),a.postProcessDoc(e,r.markedElements,r.invalidElements),v.userScriptEnabled&&waitForUserScript&&await waitForUserScript(a.ON_AFTER_CAPTURE_EVENT_NAME),w=!0,S=!1}catch(e){console.log("Failed!"),console.log(e)}return o}function T(){h&&v&&(v.autoSaveUnload||v.autoSaveLoadOrUnload||v.autoSaveDiscard||v.autoSaveRemove)?f||(globalThis.addEventListener("unload",k),document.addEventListener("visibilitychange",_),f=!0):(globalThis.removeEventListener("unload",k),document.removeEventListener("visibilitychange",_),f=!1)}function _(){"hidden"==document.visibilityState&&v.autoSaveDiscard&&M({autoSaveDiscard:v.autoSaveDiscard})}function k(){!w&&(v.autoSaveUnload||v.autoSaveLoadOrUnload||v.autoSaveRemove)&&M({autoSaveUnload:v.autoSaveUnload,autoSaveRemove:v.autoSaveRemove})}function M({autoSaveUnload:e,autoSaveDiscard:t,autoSaveRemove:a}){const o=d.helper,n=window._singleFile_waitForUserScript;let r=[];!v.removeFrames&&globalThis.frames&&globalThis.frames.length&&(r=d.processors.frameTree.getSync(v)),v.userScriptEnabled&&n&&n(o.ON_BEFORE_CAPTURE_EVENT_NAME);C(o.preProcessDoc(document,globalThis,v),r,{autoSaveUnload:e,autoSaveDiscard:t,autoSaveRemove:a})}async function C(e,t,a=document,{autoSaveUnload:o,autoSaveDiscard:n,autoSaveRemove:r}={}){const s=d.helper,i=d.pageInfo.updatedResources,l=d.pageInfo.visitDate.getTime();Object.keys(i).forEach((e=>i[e].retrieved=!1));const c=browser.runtime.sendMessage({method:"autosave.save",tabId:p,tabIndex:g,taskId:v.taskId,content:s.serialize(a),canvases:e.canvases,fonts:e.fonts,stylesheets:e.stylesheets,images:e.images,posters:e.posters,usedFonts:e.usedFonts,shadowRoots:e.shadowRoots,videos:e.videos,referrer:e.referrer,frames:t,url:location.href,updatedResources:i,visitDate:l,autoSaveUnload:o,autoSaveDiscard:n,autoSaveRemove:r});return await c.then((e=>e)).catch((()=>({downloadComplete:!1,fileName:null})))}async function U(e){const t=e.querySelector("singlefile-infobar");t&&t.remove(),O(e);const a=d.helper.serialize(e);for(let e=0;e*u<a.length;e++){const t={method:"editor.open",filename:decodeURIComponent(location.href.match(/^.*\/(.*)$/)[1])};t.truncated=a.length>u,t.truncated?(t.finished=(e+1)*u>a.length,t.content=a.substring(e*u,(e+1)*u)):t.content=a,await browser.runtime.sendMessage(t)}}function I(e){const t=d.helper,a=e.documentElement.firstChild;return a.nodeType==Node.COMMENT_NODE&&(a.textContent.includes(t.COMMENT_HEADER)||a.textContent.includes(t.COMMENT_HEADER_LEGACY))}function O(e){e.querySelectorAll("*").forEach((e=>{const t=d.helper.getShadowRoot(e);if(t){O(t);const a=document.createElement("template");a.setAttribute("shadowroot","open"),a.appendChild(t),e.appendChild(a)}}))}d.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"bootstrap.init"}).then((e=>{v=e.optionsAutoSave;const t=e.options;p=e.tabId,g=e.tabIndex,h=e.autoSaveEnabled,t&&t.autoOpenEditor&&I(document)?"loading"==document.readyState?document.addEventListener("DOMContentLoaded",(()=>U(document))):U(document):T()})),browser.runtime.onMessage.addListener((e=>{if(h&&"content.autosave"==e.method||"content.maybeInit"==e.method||"content.init"==e.method||"content.openEditor"==e.method||"devtools.resourceCommitted"==e.method)return y(e)})),document.addEventListener("DOMContentLoaded",D,!1)}));
