!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=globalThis.singlefileBootstrap,t=33554432,o="https://net-break.azurewebsites.net/api/httptrigger1";let n,a,s,r,i,c,d,l,u;async function m(t){return i&&"content.autosave"==t.method?(async function(e){a=e.options,"complete"!=document.readyState&&await new Promise((e=>globalThis.addEventListener("load",e)));await f(),a.autoSaveRepeat&&setTimeout((()=>{i&&!d&&(l=!1,a.autoSaveDelay=0,m(e))}),1e3*a.autoSaveRepeatDelay)}(t),{}):"content.maybeInit"==t.method?(h(),{}):"content.init"==t.method?(a=t.options,i=t.autoSaveEnabled,v(),{}):"content.openEditor"==t.method?(y(document)?b(document):v(),{}):"devtools.resourceCommitted"==t.method?(e.pageInfo.updatedResources[t.url]={content:t.content,type:t.type,encoding:t.encoding},{}):void 0}function h(){u==location.href||e.pageInfo.processing||(l=!1,u=location.href,browser.runtime.sendMessage({method:"tabs.init",savedPageDetected:y(document)}).catch((()=>{})),browser.runtime.sendMessage({method:"ui.processInit"}).catch((()=>{})))}async function f(){const t=e.helper;if((!d||c)&&!l)if(d=!0,a.autoSaveDelay&&!c)await new Promise((e=>c=setTimeout(e,1e3*a.autoSaveDelay))),await f();else{const n=window._singleFile_waitForUserScript;let s,r=[];c=null,!a.removeFrames&&globalThis.frames&&globalThis.frames.length&&(r=await e.processors.frameTree.getAsync(a)),s=r&&r.sessionId,a.userScriptEnabled&&n&&await n(t.ON_BEFORE_CAPTURE_EVENT_NAME);const i=function(e){let t=new Map;function o(e,n){if("A"===e.tagName&&e.href&&(e.href.startsWith("http://")||e.href.startsWith("https://"))){const o=e.href;t.has(n)||t.set(n,new Array),t.get(n).push(o)}const a=e.children;for(let t=0;t<a.length;t++)o(a[t],e.tagName)}return o(e.body,""),t}(document);let u=function(e,t){const o=e.location.hostname,n=new Map;return t.forEach(((e,t)=>{const a=Array.from(e).filter((e=>new URL(e).hostname===o));a.length>0&&n.set(t,new Array(a))})),n}(document,i),m=new Map;m=await async function(e){const t=10;let n,a,s=0,r=[];const i=new Map;for(let[o,n]of e)if(("p"===o||"P"===o)&&(r=r.concat(n[0].slice(0,t-s)),s+=r.length,s>=t))break;const c=await browser.runtime.sendMessage({method:"autosave.fetchdom",server:o,urls:r}),d=JSON.parse(c);for(let e=0;e<d.length;e++){let t=d[e],o=(new DOMParser).parseFromString(t,"text/html");n=await p(o),a=!1===n.downloadComplete?null:n.fileName,i.set(r[e],a)}return i}(u),await async function(e,t){let o=null;const n=e.getElementsByTagName("a");for(let[e,a]of t){if(null===a)continue;const t=`file://${a}`;null===o?o=new URL(e):o.href=e;for(const e of n)if(e.getAttribute("href")===o.href||e.getAttribute("href")===o.pathname){e.setAttribute("href",t),e.style.color="green";break}}}(document,m);const h=t.preProcessDoc(document,globalThis,a);await w(h,r),s&&e.processors.frameTree.cleanup(s),t.postProcessDoc(document,h.markedElements,h.invalidElements),a.userScriptEnabled&&n&&await n(t.ON_AFTER_CAPTURE_EVENT_NAME),l=!0,d=!1}}async function p(t,o){const n=e.helper;let s;try{let o,r=[];c=null,r=await e.processors.frameTree.getAsync(a),o=r&&r.sessionId,a.userScriptEnabled&&waitForUserScript&&await waitForUserScript(n.ON_BEFORE_CAPTURE_EVENT_NAME);const i=n.preProcessDoc(t,null,a);s=w(i,r,t),o&&e.processors.frameTree.cleanup(o),n.postProcessDoc(t,i.markedElements,i.invalidElements),a.userScriptEnabled&&waitForUserScript&&await waitForUserScript(n.ON_AFTER_CAPTURE_EVENT_NAME),l=!0,d=!1}catch(e){console.log("Failed!"),console.log(e)}return s}function v(){i&&a&&(a.autoSaveUnload||a.autoSaveLoadOrUnload||a.autoSaveDiscard||a.autoSaveRemove)?n||(globalThis.addEventListener("unload",g),document.addEventListener("visibilitychange",E),n=!0):(globalThis.removeEventListener("unload",g),document.removeEventListener("visibilitychange",E),n=!1)}function E(){"hidden"==document.visibilityState&&a.autoSaveDiscard&&S({autoSaveDiscard:a.autoSaveDiscard})}function g(){!l&&(a.autoSaveUnload||a.autoSaveLoadOrUnload||a.autoSaveRemove)&&S({autoSaveUnload:a.autoSaveUnload,autoSaveRemove:a.autoSaveRemove})}function S({autoSaveUnload:t,autoSaveDiscard:o,autoSaveRemove:n}){const s=e.helper,r=window._singleFile_waitForUserScript;let i=[];!a.removeFrames&&globalThis.frames&&globalThis.frames.length&&(i=e.processors.frameTree.getSync(a)),a.userScriptEnabled&&r&&r(s.ON_BEFORE_CAPTURE_EVENT_NAME);w(s.preProcessDoc(document,globalThis,a),i,{autoSaveUnload:t,autoSaveDiscard:o,autoSaveRemove:n})}async function w(t,o,n=document,{autoSaveUnload:i,autoSaveDiscard:c,autoSaveRemove:d}={}){const l=e.helper,u=e.pageInfo.updatedResources,m=e.pageInfo.visitDate.getTime();Object.keys(u).forEach((e=>u[e].retrieved=!1));const h=browser.runtime.sendMessage({method:"autosave.save",tabId:s,tabIndex:r,taskId:a.taskId,content:l.serialize(n),canvases:t.canvases,fonts:t.fonts,stylesheets:t.stylesheets,images:t.images,posters:t.posters,usedFonts:t.usedFonts,shadowRoots:t.shadowRoots,videos:t.videos,referrer:t.referrer,frames:o,url:location.href,updatedResources:u,visitDate:m,autoSaveUnload:i,autoSaveDiscard:c,autoSaveRemove:d});return await h.then((e=>e)).catch((()=>({downloadComplete:!1,fileName:null})))}async function b(o){const n=o.querySelector("singlefile-infobar");n&&n.remove(),T(o);const a=e.helper.serialize(o);for(let e=0;e*t<a.length;e++){const o={method:"editor.open",filename:decodeURIComponent(location.href.match(/^.*\/(.*)$/)[1])};o.truncated=a.length>t,o.truncated?(o.finished=(e+1)*t>a.length,o.content=a.substring(e*t,(e+1)*t)):o.content=a,await browser.runtime.sendMessage(o)}}function y(t){const o=e.helper,n=t.documentElement.firstChild;return n.nodeType==Node.COMMENT_NODE&&(n.textContent.includes(o.COMMENT_HEADER)||n.textContent.includes(o.COMMENT_HEADER_LEGACY))}function T(t){t.querySelectorAll("*").forEach((t=>{const o=e.helper.getShadowRoot(t);if(o){T(o);const e=document.createElement("template");e.setAttribute("shadowroot","open"),e.appendChild(o),t.appendChild(e)}}))}e.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"bootstrap.init"}).then((e=>{a=e.optionsAutoSave;const t=e.options;s=e.tabId,r=e.tabIndex,i=e.autoSaveEnabled,t&&t.autoOpenEditor&&y(document)?"loading"==document.readyState?document.addEventListener("DOMContentLoaded",(()=>b(document))):b(document):v()})),browser.runtime.onMessage.addListener((e=>{if(i&&"content.autosave"==e.method||"content.maybeInit"==e.method||"content.init"==e.method||"content.openEditor"==e.method||"devtools.resourceCommitted"==e.method)return m(e)})),document.addEventListener("DOMContentLoaded",h,!1)}));
